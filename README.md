# Модуль WiFiRelay

## Общее описание

Модуль предназначен для включения 2-ух раздельных каналов нагрузки переменного тока, используя выключатели-кнопки и управляющее ПО умных домов, поддерживающих управление устройствами по протоколу MQTT.

## Спецификация:

  * 2 канала с симисторным управлением (до 10 А на канал);
  * 2 входящих канала для подключения выключателей-кнопок;
  * опторазвязка между низковольтной и высоковольтной частями;
  * работа в сетях WiFi b/g/n;
  * форм-фактор для монтажа на DIN-рейку;
  * напряжение питания 5 - 20 В постоянного тока;
  * сквозное прохождение питания через модули дает возможность стекировать элементы на DIN-рейке (до 10 модулей в ряд);
  * обновление прошивки через интернет (включается при настройке модуля).

## Функции кнопок:

  * нажатие выключателя (50 мс - 1 сек) - включение/отключение канала и передача факта нажатия MQTT-серверу;
  * долгое нажатие выключателя (> 1 сек) - передача MQTT-серверу факта долгого нажатия для возможной отработки со стороны ПО умного дома;
  * нажатие кнопки перезагрузки в течении 3 сек - перезагрузка контроллера;
  * нажатие кнопки перезагрузки в течении 10 сек - сброс настроек в памяти контроллера и возврат в режим точки доступа для повторной настройки.

## Электрическая схема модуля:

![alt text](doc/WifiRelay.png)

## Первоначальная настройка:

При первом старте модуль загрузится в режиме точки доступа. Для настройки необходимо будет подключится к WiFi-сети WiFiRelay и, воспользовавшись браузером, перейти по адресу http://192.168.4.1/.

Откроется страница настроек модуля:

![alt text](doc/websetup.png)

  * Имя WiFi-сети - введите SSID точки доступа;
  * Пароль WiFi-сети - введите пароль точки доступа;
  * Адрес MQTT сервера - IP-адрес сервера с MQTT-брокером;
  * Топик MQTT сервера - тема для публикации состояния выключателей;
  * Over-The-Air обновление - включение/отключение обновления через интернет.
  
## Описание тем MQTT:

Вместо **topic** будет подставлена тема из настроек модуля.

  * **topic/status1** - состояние выключателя 1;
  * **topic/status2** - состояние выключателя 2;
  * **topic/longstatus1** - состояние долгого нажатия выключателя 1;
  * **topic/longstatus2** - состояние долгого нажатия выключателя 2.
  
Для управления состоянием извне необходима публикация **1 или 0** в эти темы.
При долгом нажатии в тему пишется число отсчетов каждые 200 мс.

При старте модуля он пишет информацию о себе в следующие темы:

  * **topic/alive** - 1 - модуль онлайн (при прерывании связи с модулем MQTT-брокер сам пишет 0 в эту тему);
  * **topic/version** - версия прошивки модуля;
  * **topic/rssi** - сила сигнала точки доступа WiFi.

Для изменения настроек модуля "на лету" можно воспользоваться следующими темами:

  * **topic/ssid** - SSID точки доступа;
  * **topic/pass** - пароль точки доступа;
  * **topic/pubtopic** - тема для публикации состояния выключателей;
  * **topic/mqttserver** - IP-адрес сервера с MQTT-брокером;
  * **topic/otaenabled** - включение/отключение обновления через интернет;
  * **topic/saveconfig** - при записи любого значения произойдет сохранение конфигурации и перезагрузка модуля.

## Обновление через интернет:

Обновление через интернет происходит только при включении модуля (при условии, что оно разрешено в настройках).
При необходимости обновления произведите ручную перезагрузку модуля нажатием кнопки перезагрузки в течении 3 секунд.
Список данных передаваемых на сервер:

 * **Remote address** - IP-адрес провайдера интернета к которому вы подключены;
 * **STA MAC** - MAC-адрес устройства WifiRelay;
 * **FREE SPACE** - количество свободной памяти в устройстве;
 * **CHIP SIZE** - размер флеш-памяти устройства;
 * **SDK VER** - версия SDK чипа ESP8266;
 * **DEV CLASS** - класс устройства (собственно WifiRelay);
 * **DEV VER** - версия прошивки устройства.

Никаких конфиденциальных данных устройство на сервер не передает.

## Credits

Данная работа основана на проекте [ESP_WiFiSwitch](https://github.com/biohazardxxx/ESP_WiFiSwitch).
