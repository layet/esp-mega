# esp-mega

## Общая информация

В системах автоматизации основная работа лежит на плечах контроллеров автоматизации. Именно к ним подключены датчики (глаза и уши системы автоматизации) и исполнительные устройства (руки и ноги :) системы). Проект контроллера **esp-mega** основан на проекте [MegaD-328](http://www.ab-log.ru/smart-house/ethernet/megad-328) и использует похожую систему настройки и управления.

#### Отличия от контроллера MegaD
* используется МК ESP8266;
* данные передаются по WiFi-соединению;
* контроллер может работать по протоколу MQTT.

## Первоначальная настройка

При первоначальном включении контроллера он создает открытую точку доступа WiFi с именем **IoTController**.
Для настройки контроллера необходимо подключится к точке доступа и перейти в браузере по адресу http://192.168.4.1.
Откроется главная страница контроллера.

Раздел **Общая информация** содержит:

Картинка1

* **Устройство** - имя устройства (используется как имя MQTT-клиента, должно быть уникально);
* **MAC-адрес** - MAC-адрес контроллера;
* **IP-адрес** - IP-адрес контроллера;
* **Свободное ОЗУ** - количество свободной памяти контроллера;
* **Время работы** - время работы контроллера в формате дни часы:минуты:секунды;
* Кнопка **Настройка** - раздел настроек модуля;
* Кнопка **Перезагрузка** - перезагрузка модуля.

Раздел **Настройки** содержит:

Картинка2

* **Имя контроллера** - настройка имени устройства (используется как имя MQTT-клиента, должно быть уникально);
* **Имя WiFi-сети** - настройка SSID для подключения к сети WiFi;
* **Пароль WiFi-сети** - настройка пароля для подключения к сети WiFi;
* **Адрес MQTT-сервера** - настройка IP-адреса брокера MQTT;
* **Топик MQTT-сервера** - настройка топика MQTT;
* **Over-the-Air обновление** - при включении данной опции контроллер при перезагрузке будет проверять обновления встроенного ПО;
* **Включить MQTT-клиент** - при включении данной опции контроллер будет отправлять события MQTT-брокеру.

Подробнее о технологии MQTT можно почитать [тут](https://ru.wikipedia.org/wiki/MQTT)

Раздел **Порты ввода-вывода** позволяет настроить порты контроллера.
Для настройки доступны 9 портов (из них 8 цифровых и 1 аналоговый порт).

Картинка3

Полем **Тип порта** порт может быть настроен как **НЕ ПОДКЛЮЧЕН/ВХОД/ВЫХОД/ЦИФРОВОЙ ДАТЧИК**.

####НЕ ПОДКЛЮЧЕН
Порт не обрабатывается устройством. Используется когда к данному входу контроллера не подключены датчики или исполнительные устройства.

####ВХОД
Порт настроен как вход. Используется для подключения датчиков, имеющих 2 состояния (выключатели, герконы, датчики движения и пр.).
Появляются дополнительные поля для настройки:
* **Действие** - действие, которое необходимо произвести. Формат поля Действие следующий: X:Y;X:Y;X:Y
где, X - номер порта, а Y (0 - выключить, 1 - включить, 2 - изменить состояние на противоположное, т.е. если было включено выключить и наоборот).
Номер порта, двоеточие, действие. Таких действий может быть несколько и тогда они разделяются точкой с запятой.
"0:2" означает, что необходимо состояние порта GPIO0 изменить на противоположное;
* **Скрипт на сервере** - URL-адрес куда нужно отправить сообщение о срабатывании входа. Формат поля следующий: http://ip-адрес/любой/путь/на/сервере?param=%val%. Возможны любые варианты URL-адреса, переменная %val% будет заменена на значение входа.
* **Тип порта** - очень важный и интересный параметр, позволяющий использовать устройство в широком спектре задач. Эта опция определяет режим входа: __Замыкание__ - устройство реагирует (то есть отправляет сообщения на сервер, выполняет сценарии и т.д.) только при замыкании контакта/выключателя, __Размыкание__ - устройство реагирует только при размыкании контакта/выключателя. __И замыкание, и размыкание__ - устройство реагирует как на замыкание, так и на размыкания контакта.

## Credits

Данная работа основана на проекте [ESP_WiFiSwitch](https://github.com/biohazardxxx/ESP_WiFiSwitch).
